<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio recorder</title>
  </head>
  <body>
    <input type="file" name="testWAV" id="testWAV">
    <audio id="player" controls></audio>
    <button id="record">Record</button>
    <button id="stop">Stop</button>
    <a id="download">Download audio</a>
    <script>
      const player = document.getElementById("player");
      const stopBtn = document.getElementById("stop");
      const recordBtn = document.getElementById("record");
      const input = document.getElementById("testWAV");
      let shouldStop = false;
      let stopped = false;
      const downloadLink = document.getElementById("download");

      const handleSuccess = function (stream) {
        const options = { mimeType: "audio/webm" };
        let recordedChunks = [];
        const mediaRecorder = new MediaRecorder(stream, options);
        mediaRecorder.addEventListener("dataavailable", function (e) {
          if (e.data.size > 0) {
            recordedChunks.push(e.data);
          }
          console.log(recordedChunks);
        });
        stopBtn.addEventListener("click", function () {
          mediaRecorder.stop();
        });

        mediaRecorder.addEventListener("stop", function () {
          downloadLink.href = URL.createObjectURL(new Blob(recordedChunks));
          downloadLink.download = "acetest.wav";
          player.src = URL.createObjectURL(new Blob(recordedChunks));

          var fileName = "aaaaa.wav";

          var fileContent = 'sample text'; // As a sample, upload a text file.
          var file = new Blob(recordedChunks, {type: 'audio/webm'});
          var metadata = {
              'name': 'aaaaaaa.wav', // Filename at Google Drive
              'mimeType': 'application/binary', // mimeType at Google Drive
              'parents': '', // Folder ID at Google Drive
          };

          var accessToken = gapi.auth.getToken().access_token; // Here gapi is used for retrieving the access token.
          var form = new FormData();
          form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
          // file.text().then(function (buffer) {
            form.append('file', file);
            // console.log(buffer)
            var xhr = new XMLHttpRequest();
            xhr.open('post', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id');
            xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            xhr.responseType = 'json';
            xhr.onload = () => {
                console.log(xhr.response.id); // Retrieve uploaded file ID.
            };
            xhr.send(form);
          // })

          /* (new Blob(recordedChunks, {type: ''})).text().then(function (buffer) {
            gapi.client.drive.files.create(buffer, {
              'uploadType': "media"
            }).then(function(response) {
              console.log(response)
            })
          }) */
          // var file = new File([recordedChunks], 'fileName', {type: 'audio/webm'})

         /*  (new Blob(recordedChunks, {type: "audio/webm"})).text().then(function (buffer) {
            var contentType = "audio/webm";
            var metadata = {
              name: fileName,
              // mimeType: contentType,
            };
            const boundary = "myfile";
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            var multipartRequestBody =
              delimiter +
              "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
              JSON.stringify(metadata) +
              delimiter +
              "Content-Type: " +
              contentType +
              "\r\n\r\n" +
              buffer +
              "\r\n" +
              close_delim;

            var request = window.gapi.client.request({
              path: "https://www.googleapis.com/upload/drive/v3/files",
              method: "POST",
              params: { uploadType: "multipart" },
              headers: {
                "Content-Type": "multipart/related; boundary=" + boundary + "",
              },
              body: multipartRequestBody,
            });
            request.execute(function (file) {
              console.log(file);
            });
          });
 */
          recordedChunks = [];
        });

        recordBtn.addEventListener("click", function () {
          mediaRecorder.start(500);
        });
      };

      navigator.mediaDevices
        .getUserMedia({ audio: true, video: false })
        .then(handleSuccess);
    </script>

    <p>Drive API Quickstart</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" style="display: none">Authorize</button>
    <button id="signout_button" style="display: none">Sign Out</button>

    <pre id="content" style="white-space: pre-wrap"></pre>
    <script src="googledrive-connect.js" type="text/javascript"></script>
    <script
      async
      defer
      src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()"
    ></script>
  </body>
</html>
